[env]
_.python.venv = { path = ".venv" }

[tools]
cargo = "latest"
rust = "latest"
uv = "latest"
"cargo:cargo-nextest" = "latest"
"cargo:cargo-hack" = "latest"

[tasks.develop]
description = "Build the CPU extension and install the Python wrapper in editable mode"
run = '''
uv run --with "maturin[patchelf]>=1.7,<2" maturin build --manifest-path py-laddu-cpu/Cargo.toml --release -o py-laddu-cpu/dist
uv pip install --find-links py-laddu-cpu/dist laddu-cpu
uv pip install --find-links py-laddu-cpu/dist -e py-laddu
'''

[tasks.develop-tests]
description = "Install the CPU stack with the testing extra"
depends = ["develop"]
run = "uv pip install --find-links py-laddu-cpu/dist -e 'py-laddu[tests]'"

[tasks.develop-mpi]
description = "Build both CPU and MPI extensions and install the wrapper"
run = '''
uv run --with "maturin[patchelf]>=1.7,<2" maturin build --manifest-path py-laddu-cpu/Cargo.toml --release -o py-laddu-cpu/dist
uv run --with "maturin[patchelf]>=1.7,<2" maturin build --manifest-path py-laddu-mpi/Cargo.toml --release -o py-laddu-mpi/dist --features mpi
uv pip install --find-links py-laddu-cpu/dist --find-links py-laddu-mpi/dist laddu-cpu laddu-mpi
uv pip install --find-links py-laddu-cpu/dist --find-links py-laddu-mpi/dist -e 'py-laddu[mpi]'
'''

[tasks.develop-mpi-tests]
description = "Build both extensions and install all Python extras"
depends = ["develop-mpi"]
run = "uv pip install --find-links py-laddu-cpu/dist --find-links py-laddu-mpi/dist -e 'py-laddu[tests,mpi]'"

[tasks.test-python]
description = "Run the Python test suite"
depends = ["develop-tests"]
run = "uv run python -m pytest py-laddu"

[tasks.test-python-mpi]
description = "Run the Python test suite with MPI bindings installed"
depends = ["develop-mpi-tests"]
run = "uv run python -m pytest py-laddu"

[tasks.test-rust]
description = "Run Rust nextest and doctests"
run = '''
cargo nextest run
cargo test --doc
'''

[tasks.test-rust-mpi]
description = "Run Rust tests with MPI features"
run = '''
cargo nextest run --features mpi
cargo test --doc --features mpi
'''

[tasks.test]
description = "Run all tests"
depends = ["test-rust", "test-python"]

[tasks.test-mpi]
description = "Run all tests with MPI features"
depends = ["test-rust-mpi", "test-python-mpi"]

[tasks.lint-python]
description = "Run Ruff checks"
run = '''
uv run ruff check py-laddu
uv run ruff format --check py-laddu
uv run ty check
'''

[tasks.lint-rust]
description = "Run cargo clippy"
run = "cargo clippy --all-targets"

[tasks.lint-rust-mpi]
description = "Run cargo clippy with MPI features"
run = "cargo clippy --all-targets --features mpi"

[tasks.lint]
description = "Run all linters"
depends = ["lint-rust", "lint-python"]

[tasks.lint-mpi]
description = "Run all linters with MPI features"
depends = ["lint-rust-mpi", "lint-python"]

[tasks.build-rust]
description = "Build all Rust crates"
run = "cargo build --all-targets"

[tasks.build-rust-mpi]
description = "Build all Rust crates with MPI features"
run = "cargo build --all-targets --features mpi"

[tasks.build-python]
description = "Build Python distributions"
run = '''
uv run --with "maturin[patchelf]>=1.7,<2" maturin build --release --manifest-path py-laddu-cpu/Cargo.toml
uv run --with "maturin[patchelf]>=1.7,<2" maturin build --release --manifest-path py-laddu-mpi/Cargo.toml --features mpi
uv build -o dist py-laddu
'''

[tasks.build]
description = "Build all Rust and Python artifacts"
depends = ["build-rust", "build-python"]

[tasks.clean-rust]
description = "Run cargo clean"
run = "cargo clean"

[tasks.clean-python]
description = "Remove Python build artifacts"
run = "rm -rf .venv .uv-cache dist py-laddu/build"

[tasks.clean]
description = "Clean all build artifacts"
depends = ["clean-rust", "clean-python"]

[tasks.docs-rust]
description = "Build Rust documentation"
run = "cargo doc --all-features"

[tasks.docs-python]
description = "Build Python documentation"
run = '''
uv pip install -e 'py-laddu[docs]'
make -C py-laddu/docs html
'''
depends = ["develop"]

[tasks.docs]
description = "Build all documentation"
depends = ["docs-rust", "docs-python"]

[tasks.cargo-hack-check]
description = "Run cargo-hack check across feature sets"
run = "cargo hack check --rust-version --each-feature --no-dev-deps"

[tasks.cargo-hack-test]
description = "Run cargo-hack tests across feature sets"
run = "cargo hack test --each-feature"

[tasks.cargo-hack]
description = "Run the cargo-hack matrix (check + test)"
depends = ["cargo-hack-check", "cargo-hack-test"]

[tasks.docker-build]
description = "Build the laddu development Docker image"
run = '''#!/usr/bin/env bash
set -euo pipefail
ROOT_DIR=$(pwd)
IMAGE=${LADDU_DOCKER_IMAGE:-laddu:latest}
docker build -t "$IMAGE" "$ROOT_DIR"
'''

[tasks.docker-shell]
description = "Drop into the Docker development shell"
run = '''#!/usr/bin/env bash
set -euo pipefail
ROOT_DIR=$(pwd)
IMAGE=${LADDU_DOCKER_IMAGE:-laddu:latest}
SRC=/src
WORKDIR=/work
FLAG=LADDU_INSIDE_DOCKER
cmd=(
  docker run --rm
  -v "$ROOT_DIR:$SRC:ro"
  --tmpfs "$WORKDIR:rw,exec,nosuid,size=8g"
  --tmpfs "$WORKDIR/.venv:rw,exec,nosuid,size=2g"
  -w "$WORKDIR"
  -e "$FLAG=1"
  -e "LD_LIBRARY_PATH=$WORKDIR/.venv/lib:$LD_LIBRARY_PATH"
)
if [[ -t 0 ]]; then
  cmd+=(-i)
fi
if [[ -t 1 ]]; then
  cmd+=(-t)
fi
INNER=$(cat <<'SH'
set -euo pipefail
mkdir -p /work
rsync -a --delete --exclude 'target/' --exclude '.venv/' --exclude '__pycache__/' /src/ /work/
export PATH="/root/.local/bin:/root/.mise/bin:$PATH"
mise trust /work
mise exec uv -- env SYSTEM_CONFIGURATION_DISABLE=1 UV_CACHE_DIR=/work/.uv-cache uv venv /work/.venv
PYTHON_LIB=$(find /root/.local/share/uv/python -maxdepth 2 -type d -name "cpython-*-linux-*-gnu" | head -n 1)/lib || true
export LD_LIBRARY_PATH=$PYTHON_LIB:$LD_LIBRARY_PATH
cd /work
exec bash
SH
)
cmd+=("$IMAGE" "bash" "-lc" "$INNER")
exec "${cmd[@]}"
'''

[tasks.sync-versions]
description = "Sync Python package versions with the Rust workspace"
run = '''#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# ///
from __future__ import annotations

import re
from pathlib import Path

import tomllib

root = Path.cwd()
workspace = tomllib.loads((root / 'Cargo.toml').read_text())
version = workspace['workspace']['dependencies']['laddu']['version']

wrapper_path = root / 'py-laddu' / 'pyproject.toml'
text = wrapper_path.read_text()


def replace_once(source: str, pattern: str, replacement: str) -> str:
    compiled = re.compile(pattern, re.MULTILINE)
    new_text, count = compiled.subn(replacement, source, count=1)
    if count == 0:
        msg = f'Pattern {pattern!r} not found in {wrapper_path}'
        raise RuntimeError(msg)
    return new_text


text = replace_once(text, r'^version\s*=\s*".*"$', f'version = "{version}"')
text = replace_once(text, r'^\s*"laddu-cpu ==[^\"]+",$', f'  "laddu-cpu == {version}",')
text = replace_once(text, r'^mpi = \["laddu-mpi ==[^\"]+"\]$', f'mpi = ["laddu-mpi == {version}"]')
wrapper_path.write_text(text)
print(f'Successfully synced versions to {version}')
'''

[tasks.coverage-rust]
description = "Generate the Rust LCOV report"
run = "cargo llvm-cov --workspace --lcov --output-path coverage-rust.lcov --summary-only --exclude-from-report py-laddu -F rayon"

[tasks.coverage-python]
description = "Generate the Python coverage XML"
depends = ["develop-tests"]
run = "uv run python -m pytest --cov --cov-report xml:coverage-python.xml"

[tasks.coverage]
description = "Generate both coverage artifacts"
depends = ["coverage-rust", "coverage-python"]
